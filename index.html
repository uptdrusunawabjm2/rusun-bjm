<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Daftar Penghuni Rusunawa</title>

<style>
:root{
--bg:#0f172a;--card:#1e293b;--muted:#94a3b8;--accent:#e2e8f0;
--ready:#22c55e;--occupied:#3b82f6;--broken:#ef4444}
body{margin:0;background:var(--bg);font-family:Segoe UI,Arial;color:var(--accent)}
.wrap{max-width:1200px;margin:auto;padding:16px}
.card{background:var(--card);border-radius:16px;padding:18px}
.title{font-size:22px;font-weight:700;margin-bottom:6px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
input,select{padding:10px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#e2e8f0}
table{width:100%;border-collapse:collapse}
thead th{background:#1e293b;padding:10px;text-align:left}
td{padding:10px;border-bottom:1px solid #334155}
.badge{padding:4px 10px;border-radius:999px;font-size:12px;color:#fff}
.ready{background:var(--ready)}.occupied{background:var(--occupied)}.broken{background:var(--broken)}
.summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:12px}
.box{padding:12px;border-radius:12px;color:#fff}
.total{background:#334155}.siap{background:#16a34a}.isi{background:#2563eb}.rusak{background:#dc2626}
</style>
</head>

<body>
<div class="wrap">
<div class="card">

<div class="title">Daftar Penghuni Rusunawa</div>

<div class="controls">
<input id="search" placeholder="Cari unit / nama"/>
<select id="filter">
<option value="">Semua Kondisi</option>
<option>Terisi</option>
<option>Siap Huni</option>
<option>Rusak</option>
</select>
<select id="lokasi">
<option value="">Semua Lokasi</option>
<option value="GM-">Ganda Maghfirah</option>
<option value="TK-">Teluk Kelayan</option>
</select>
</div>

<div id="summary" class="summary"></div>

<div style="max-height:65vh;overflow:auto">
<table>
<thead>
<tr>
<th>Unit</th>
<th>Nama</th>
<th>Telp</th>
<th>Kondisi Unit</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>
</div>

<script>
/* ================= CONFIG ================= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzjABRVgRaoMj3Y1gCU_DRJpnZIvkGwxRRxmPW6buV1POsQ87GQCLAeEBG5j9jJZux7iQ/exec";
const CACHE_KEY = "RUSUN_CACHE_V3";

/* ================= STATE ================= */
let RAW = [];
let VIEW = [];

/* ================= FAST FETCH ================= */
async function load(){
try{

// ===== CACHE INSTANT LOAD =====
const cache = sessionStorage.getItem(CACHE_KEY);
if(cache){
RAW = JSON.parse(cache);
VIEW = RAW;
render();
}

// ===== BACKGROUND REFRESH =====
const controller = new AbortController();
setTimeout(()=>controller.abort(), 8000);

const res = await fetch(GAS_URL + "?action=internal&key=rusun2026", {
  signal: controller.signal
});

const json = await res.json();

if(!json.status) return;

RAW = json.data.map(r=>{

const unit =
r.unit ||
r["No. Unit"] ||
r.Unit ||
"";

const nama =
r.nama ||
r["Nama Penghuni"] ||
r.Nama ||
"";

const telp =
r.telp ||
r["Nomor Telp./HP"] ||
r["no telp"] ||
"";

const kondisi = String(
r.kondisiunit ?? r.kondisi ?? r["Kondisi Unit"] ?? ""
).trim();

return {
Unit: String(unit).trim(),
Nama: String(nama).trim(),
Telp: String(telp).trim(),
"Kondisi Unit": String(kondisi).trim()
};
});

RAW.sort((a,b)=> a.Unit.localeCompare(b.Unit, undefined, {numeric:true}));
sessionStorage.setItem(CACHE_KEY, JSON.stringify(RAW));
VIEW = RAW;
render();
}
catch(e){
if(e.name === "AbortError"){
console.warn("Fetch timeout â€” pakai cache");
}else{
console.error("GAS ERROR", e);
}
}
}


/* ================= FAST RENDER ================= */
function render(){

// ===== SUMMARY =====
let total = VIEW.length;
let terisi = 0, siap = 0, rusak = 0;

for(const d of VIEW){
let k = String(d["Kondisi Unit"] || "")
.toLowerCase()
.replace(/\s+/g," ")
.trim();

if(k.includes("terisi")) terisi++;
else if(k.includes("siap")) siap++;
else if(k.includes("rusak")) rusak++;

}

document.getElementById("summary").innerHTML = `
<div class="box total">TOTAL<br><b>${total}</b></div>
<div class="box isi">TERISI<br><b>${terisi}</b></div>
<div class="box siap">SIAP<br><b>${siap}</b></div>
<div class="box rusak">RUSAK<br><b>${rusak}</b></div>`;

// ===== TABLE FAST BUILD (NO REFLOW) =====
let html = "";
for(const d of VIEW){
let k = String(d["Kondisi Unit"] || "")
.toLowerCase()
.replace(/\s+/g," ")
.trim();

let cls = "ready";
if(k.includes("terisi")) cls="occupied";
else if(k.includes("rusak")) cls="broken";


html += `<tr>
<td>${d.Unit}</td>
<td>${d.Nama}</td>
<td>${d.Telp}</td>
<td><span class="badge ${cls}">${d["Kondisi Unit"]}</span></td>
</tr>`;
}

document.getElementById("tbody").innerHTML = html;
}

/* ================= FILTER SUPER CEPAT ================= */
function applyFilter(){

const s = document.getElementById("search").value.toLowerCase();
const f = document.getElementById("filter").value;
const l = document.getElementById("lokasi").value;

VIEW = RAW.filter(d=>{

if(f && d["Kondisi Unit"]!==f) return false;
if(l && !d.Unit.startsWith(l)) return false;

if(!s) return true;
return (
d.Unit.toLowerCase().includes(s) ||
d.Nama.toLowerCase().includes(s)
);
});

render();
}

/* ================= EVENTS ================= */
document.getElementById("search").oninput = applyFilter;
document.getElementById("filter").onchange = applyFilter;
document.getElementById("lokasi").onchange = applyFilter;

/* ================= START ================= */
load();
</script>

</body>
</html>
