<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Daftar Penghuni Rusunawa</title>

<style>
:root{
--bg:#0f172a;--card:#1e293b;--accent:#e2e8f0;
--ready:#22c55e;--occupied:#3b82f6;--broken:#ef4444}
body{margin:0;background:var(--bg);font-family:Segoe UI,Arial;color:var(--accent)}
.wrap{max-width:1200px;margin:auto;padding:16px}
.card{background:var(--card);border-radius:16px;padding:18px}
.title{font-size:22px;font-weight:700;margin-bottom:10px}

.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
input,select,button{
padding:10px;border-radius:10px;border:1px solid #334155;
background:#0f172a;color:#e2e8f0
}
button{cursor:pointer}
button:hover{background:#1e293b}

.summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:12px}
.box{padding:12px;border-radius:12px;color:#fff}
.total{background:#334155}.siap{background:#16a34a}.isi{background:#2563eb}.rusak{background:#dc2626}

table{width:100%;border-collapse:collapse}
thead th{background:#1e293b;padding:10px;text-align:left}
td{padding:10px;border-bottom:1px solid #334155}
tbody tr:hover{background:rgba(255,255,255,0.03)}

td:first-child{font-family:monospace;font-weight:600}
td:nth-child(3){font-family:monospace;color:#cfd8ff}

.badge{padding:4px 10px;border-radius:999px;font-size:12px;color:#fff}
.ready{background:var(--ready)}
.occupied{background:var(--occupied)}
.broken{background:var(--broken)}

/* ================= TEXT STYLE SERAGAM ================= */

body{
font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

.title{
letter-spacing:.3px;
}

td, th{
font-size:14px;
}

td:first-child{
text-transform:uppercase;
letter-spacing:.6px;
}

td:nth-child(2){
font-weight:500;
}

td:nth-child(3){
font-family:monospace;
}

.badge{
font-weight:600;
letter-spacing:.4px;
}

.unit-link{
cursor:pointer;
color:#93c5fd;
}
.unit-link:hover{
text-decoration:underline;
}

/* ================= POPUP BASE ================= */

.popup-overlay{
display:none;
position:fixed;
inset:0;
background:rgba(0,0,0,.6);
z-index:9999;
align-items:center;
justify-content:center;
}

.popup-card{
background:linear-gradient(145deg,#1e293b,#111827);
width:95%;
max-width:720px;
max-height:88vh;
overflow:auto;
border-radius:22px;
padding:24px;
position:relative;
color:#e2e8f0;
border:1px solid rgba(255,255,255,.05);
box-shadow:
0 25px 60px rgba(0,0,0,.6),
0 8px 20px rgba(0,0,0,.3);
}

/* ================= POPUP CARD CONTENT ================= */

.popup-section{
margin-bottom:12px;
}

.popup-title{
font-size:14px;
font-weight:600;
margin-bottom:6px;
letter-spacing:.3px;
color:#93c5fd;
}

.popup-grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:6px 10px;
font-size:13px;
}

.popup-item{
background:#0f172a;
padding:8px;
border-radius:10px;
line-height:1.3;
}

/* ================= PDAM SAMPAH ================= */

.pdam-box{
background:#111827;
padding:10px;
border-radius:12px;
font-size:13px;
line-height:1.4;
}

.pdam-row{
display:flex;
justify-content:space-between;
margin-bottom:4px;
}

.pdam-label{
opacity:.6;
font-size:12px;
}

/* ================= FINANCIAL CARD ================= */

.popup-finance{
display:grid;
grid-template-columns:1fr 1fr;
gap:10px;
margin-top:6px;
}

.finance-box{
padding:10px;
border-radius:12px;
text-align:center;
font-size:13px;
font-weight:600;
}

.finance-paid{
background:#064e3b;
color:#34d399;
}

.finance-due{
background:#7f1d1d;
color:#f87171;
}

/* ================= PDAM TOTAL CUSTOM ================= */

.finance-pdam{
background:#0c4a6e;      /* biru tua */
color:#38bdf8;           /* biru terang */
}

.finance-sampah{
background:#3f1d7a;      /* ungu tua */
color:#c084fc;           /* ungu terang */
}

/* ================================== */

@media (max-width:720px){
.popup-finance{
grid-template-columns:1fr;
gap:8px;
}
}

.popup-item span{
display:block;
font-size:11px;
opacity:.6;
margin-bottom:2px;
}

/* Mobile tighter */
@media (max-width:720px){

.popup-grid{
grid-template-columns:1fr;
gap:6px;
}

.popup-item{
padding:7px;
font-size:12px;
}

.popup-title{
font-size:13px;
}

}

.popup-close{
position:absolute;
top:8px;
right:10px;
background:#ef4444;
border:none;
color:#fff;
font-size:16px;
padding:4px 10px;
border-radius:8px;
cursor:pointer;
}

/* ================= ULTRA COMPACT MOBILE ================= */

@media (max-width:720px){

.popup-overlay{
align-items:flex-end;
}

.popup-card{
width:100%;
max-width:none;
height:75vh;
max-height:none;
border-radius:16px 16px 0 0;
padding:14px;
font-size:13px;
}

.popup-card h3{
font-size:16px;
margin-bottom:8px;
}

.popup-card p{
margin:4px 0;
line-height:1.3;
}

.popup-card h4{
margin-top:10px;
font-size:14px;
}

.popup-close{
top:6px;
right:8px;
padding:3px 8px;
font-size:14px;
}

}

/* ================= MOBILE RESPONSIVE ================= */

@media (max-width: 720px){

.wrap{
padding:10px;
}

.card{
padding:12px;
border-radius:12px;
}

.title{
font-size:18px;
text-align:center;
}

.controls{
flex-direction:column;
gap:8px;
}

input, select, button{
width:100%;
font-size:14px;
padding:10px;
}

.summary{
grid-template-columns:repeat(2,1fr);
gap:8px;
}

.box{
padding:10px;
font-size:13px;
text-align:center;
}

table{
font-size:13px;
}

thead{
position:sticky;
top:0;
z-index:5;
}

td, th{
padding:8px;
}

td:nth-child(3){
font-size:12px;
}

/* SCROLL TABLE MOBILE */
.table-wrap{
overflow-x:auto;
}

/* Optional: nama dipotong rapi */
td:nth-child(2){
max-width:140px;
white-space:nowrap;
overflow:hidden;
text-overflow:ellipsis;
}

/* ===== SAMAKAN FIELD SEARCH / FILTER / RESET ===== */

.controls input,
.controls select,
.controls button{
width:100%;
box-sizing:border-box;
height:44px;
padding:10px 12px;
border-radius:12px;
border:1px solid #334155;
background:#0f172a;
color:#e2e8f0;
font-size:14px;
outline:none;
}

.controls input:focus,
.controls select:focus{
border-color:#3b82f6;
box-shadow:0 0 0 1px #3b82f6;
}

#resetBtn{
display:flex;
align-items:center;
justify-content:center;
font-weight:600;
letter-spacing:.3px;
}

.controls input,
.controls select{
appearance:none;
-webkit-appearance:none;
-moz-appearance:none;
}

}

</style>
</head>

<body>
<div class="wrap">
<div class="card">

<div class="title">Daftar Penghuni Rusunawa</div>

<div class="controls">
<input id="search" placeholder="Cari unit / nama"/>
<select id="filter">
<option value="">Semua Kondisi</option>
<option>Terisi</option>
<option>Siap Huni</option>
<option>Rusak</option>
</select>

<select id="lokasi">
<option value="">Semua Lokasi</option>
<option value="GM-">Ganda Maghfirah</option>
<option value="TK-">Teluk Kelayan</option>
</select>

<button id="resetBtn">Reset</button>
</div>

<div id="summary" class="summary"></div>

<div class="table-wrap" style="max-height:65vh;overflow:auto">
<table>
<thead>
<tr>
<th>Unit</th>
<th>Nama</th>
<th>Telp</th>
<th>Kondisi Unit</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>
</div>

<script>
const GAS_URL="https://script.google.com/macros/s/AKfycbzjABRVgRaoMj3Y1gCU_DRJpnZIvkGwxRRxmPW6buV1POsQ87GQCLAeEBG5j9jJZux7iQ/exec";
const CACHE_KEY="RUSUN_CACHE_V3";

let RAW=[],VIEW=[];
let INTERNAL_MAP = {};

async function load(){
try{
const cache=sessionStorage.getItem(CACHE_KEY);
if(cache){
  const parsed = JSON.parse(cache);
  RAW = parsed.RAW;
  INTERNAL_MAP = parsed.INTERNAL_MAP || {};
  VIEW = RAW;
  render();
}

const controller=new AbortController();
setTimeout(()=>controller.abort(),8000);

const res=await fetch(GAS_URL+"?action=internal&key=rusun2026",{signal:controller.signal});
const json=await res.json();
if(!json.status)return;

const rows=json?.data?.data||[];

// simpan full data internal untuk popup
(rows || []).forEach(r=>{
  if(r.unit){
    INTERNAL_MAP[String(r.unit).toLowerCase()] = r;
  }
});

RAW=rows.map(r=>({
Unit:String(r.unit||r["No. Unit"]||r.Unit||"").trim(),
Nama:String(r.nama||r["Nama Penghuni"]||r.Nama||"").trim(),
Telp:String(r.telp||r["Nomor Telp./HP"]||"").trim(),
"Kondisi Unit":String(r.kondisiunit||r.kondisi||r["Kondisi Unit"]||"").trim()
}));

RAW.sort((a,b)=>a.Unit.localeCompare(b.Unit,undefined,{numeric:true}));
sessionStorage.setItem(
  CACHE_KEY,
  JSON.stringify({
    RAW: RAW,
    INTERNAL_MAP: INTERNAL_MAP
  })
);
VIEW=RAW;
render();
}catch(e){
if(e.name!=="AbortError")console.error(e);
}
}

function render(){
let total=VIEW.length,terisi=0,siap=0,rusak=0;

for(const d of VIEW){
const k=d["Kondisi Unit"].toLowerCase();
if(k.includes("terisi"))terisi++;
else if(k.includes("siap"))siap++;
else if(k.includes("rusak"))rusak++;
}

document.getElementById("summary").innerHTML=`
<div class="box total">TOTAL<br><b>${total}</b></div>
<div class="box isi">TERISI<br><b>${terisi}</b></div>
<div class="box siap">SIAP<br><b>${siap}</b></div>
<div class="box rusak">RUSAK<br><b>${rusak}</b></div>`;

let html="";
for(const d of VIEW){
const k=d["Kondisi Unit"].toLowerCase();
let cls="ready";
if(k.includes("terisi"))cls="occupied";
else if(k.includes("rusak"))cls="broken";

html+=`<tr>
<td>
  <span class="unit-link" data-unit="${d.Unit.toLowerCase()}">
    ${d.Unit.toUpperCase()}
  </span>
</td>
<td>${d.Nama}</td>
<td>${d.Telp}</td>
<td><span class="badge ${cls}">${d["Kondisi Unit"]}</span></td>
</tr>`;
}
document.getElementById("tbody").innerHTML=html;
}

function applyFilter(){
const s=document.getElementById("search").value.toLowerCase();
const f=document.getElementById("filter").value.toLowerCase();
const l=document.getElementById("lokasi").value;

VIEW=RAW.filter(d=>{
if(f&&!d["Kondisi Unit"].toLowerCase().includes(f))return false;
if(l&&!d.Unit.toUpperCase().startsWith(l))return false;
if(!s)return true;
return d.Unit.toLowerCase().includes(s)||d.Nama.toLowerCase().includes(s);
});
render();
}

document.getElementById("search").oninput=applyFilter;
document.getElementById("filter").onchange=applyFilter;
document.getElementById("lokasi").onchange=applyFilter;

document.getElementById("resetBtn").onclick=()=>{
document.getElementById("search").value="";
document.getElementById("filter").value="";
document.getElementById("lokasi").value="";
VIEW=RAW;
render();
};

document.addEventListener("click",function(e){
  if(e.target.classList.contains("unit-link")){
    const unit = e.target.dataset.unit.toLowerCase();
    showPopup(unit);
  }
});

function showPopup(unit){
  const d = INTERNAL_MAP[unit];
  if(!d) return alert("Data tidak ditemukan");

  const anggota = [d.anggota1,d.anggota2,d.anggota3,d.anggota4]
    .filter(a=>a && String(a).trim()!=="");

  const totalBayar = Number(d.pembayaran||0);
  const totalTunggakan = Number(d.tunggakan||0);
  const totalPdam = Number(String(d.pdamSampah?.["total pdam"] || 0).replace(/[^\d]/g,""));
  const totalSampah = Number(String(d.pdamSampah?.["total sampah"] || 0).replace(/[^\d]/g,""));

  const semuaPerjanjian = (d.riwayatPerjanjian||[]);
    let perjanjianAktif = null;
    const today = new Date();
    for(const p of semuaPerjanjian){
    const mulai = new Date(p.tgl_perjanjian_mulai_penghuni||0);
    const akhir = new Date(p.tgl_perjanjian_akhir_penghuni||0);
    if(mulai && akhir && today >= mulai && today <= akhir){
        perjanjianAktif = p;
        break;
    }
    }
    const perjanjian = perjanjianAktif || semuaPerjanjian[0] || null;

  document.getElementById("popupContent").innerHTML = `

    <div class="popup-section">
      <div class="popup-title">Identitas Penghuni</div>
      <div class="popup-grid">
        <div class="popup-item"><span>Nama</span>${d.nama||"-"}</div>
        <div class="popup-item"><span>Telp</span>${d.telp||"-"}</div>
        <div class="popup-item"><span>Email</span>${d.email||"-"}</div>
        <div class="popup-item"><span>Pekerjaan</span>${d.pekerjaan||"-"}</div>
      </div>
    </div>

    <div class="popup-section">
      <div class="popup-title">Anggota Keluarga</div>
      ${
        anggota.length
        ? `<div class="popup-grid">
            ${anggota.map(a=>`
              <div class="popup-item">${a}</div>
            `).join("")}
           </div>`
        : `<div class="popup-item">Tidak ada data</div>`
      }
    </div>

    <div class="popup-section">
      <div class="popup-title">Penjamin</div>
      <div class="popup-grid">
        <div class="popup-item"><span>Nama</span>${d.penjamin||"-"}</div>
        <div class="popup-item"><span>Telp</span>${d.telpPenjamin||"-"}</div>
        </div>
    </div>

        <div class="popup-section">
      <div class="popup-title">Total Pembayaran & Tunggakan</div>
      <div class="popup-finance">
        <div class="finance-box finance-paid">
          Total Bayar<br>
          Rp ${totalBayar.toLocaleString("id-ID")}
        </div>
        <div class="finance-box finance-due">
          Total Tunggakan<br>
          Rp ${totalTunggakan.toLocaleString("id-ID")}
        </div>
      </div>
    </div>

    <div class="popup-section">
  <div class="popup-title">Riwayat Tunggakan PDAM & Sampah</div>
  ${
    d.pdamSampah && Object.keys(d.pdamSampah).length
    ? `
    <div class="popup-finance">
    <div class="finance-box finance-pdam">
      Total PDAM<br>
        Rp ${totalPdam.toLocaleString("id-ID")}
    </div>
    <div class="finance-box finance-sampah">
        Total Sampah<br>
        Rp ${totalSampah.toLocaleString("id-ID")}
    </div>
    </div>
    <div class="pdam-box">
        ${
          Object.entries(d.pdamSampah)
          .filter(([k,v]) =>
            k !== "unit" &&
            k !== "total pdam" &&
            k !== "total sampah" &&
            v
            )
            .map(([k,v])=>{
            let value = v ?? "-";
            const key = String(k).toLowerCase().trim();
            if(
                key.includes("jlh_uang") ||
                key === "total pdam" ||
                key === "total sampah"
            ){
                const cleaned = String(value).replace(/[^\d]/g,"");
                const num = Number(cleaned || 0);
                value = "Rp " + num.toLocaleString("id-ID");
            }
            return `
                <div class="pdam-row">
                <div class="pdam-label">${k}</div>
                <div>${value}</div>
                </div>
            `;
            }).join("")
        }
       </div>`
    : `<div class="popup-item">Tidak ada data</div>`
  }
</div>

    <div class="popup-section">
        <div class="popup-title">Riwayat Perjanjian</div>
        ${
            perjanjian
            ? `<div class="popup-item">
                <span>No Perjanjian</span>
                ${perjanjian.no_perjanjian_penghuni||"-"}<br>
                <span>Mulai</span>
                ${perjanjian.tgl_perjanjian_mulai_penghuni||"-"}<br>
                <span>Akhir</span>
                ${perjanjian.tgl_perjanjian_akhir_penghuni||"-"}
            </div>`
            : `<div class="popup-item">Tidak ada data</div>`
        }
    </div>

    <div class="popup-section">
      <div class="popup-title">Riwayat Nama Penghuni</div>
      ${
        (d.riwayatNamaPenghuni||[]).length
        ? `<div class="popup-grid">
            ${(d.riwayatNamaPenghuni||[]).map(n=>`
              <div class="popup-item">${n}</div>
            `).join("")}
           </div>`
        : `<div class="popup-item">Tidak ada data</div>`
      }
    </div>

  `;

  document.getElementById("popup").style.display="flex";
}

function closePopup(){
  document.getElementById("popup").style.display="none";
}

load();

</script>
<div id="popup" class="popup-overlay">
  <div class="popup-card">
    <button class="popup-close" onclick="closePopup()">Ã—</button>
    <div id="popupContent"></div>
  </div>
</div>
</body>
</html>
